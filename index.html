<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Snake AI 5-Step Lookahead</title>
<style>
  body { 
    display:flex; flex-direction:column; align-items:center; 
    font-family:sans-serif; background:#111; color:white; margin:0; padding:20px;
  }
  canvas { background:#222; margin:20px 0; border:2px solid #00f; }
  button { padding:10px 20px; margin:5px; background:#00f; color:white; border:none; cursor:pointer; border-radius:4px; }
  button:hover { background:#0055ff; }
  label { margin-left:10px; }
</style>
</head>
<body>
<h2>Snake AI Game</h2>
<canvas id="gameCanvas" width="608" height="608"></canvas>
<div>
  <button id="playAgain">Play Again</button>
  <label><input type="checkbox" id="useAI"> Use AI</label>
</div>
<h3>Score: <span id="score">0</span></h3>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const box = 32;
let score = 0;
let snake, food, d, interval;
let useAI = false;
const scoreEl = document.getElementById("score");

const eatSound = new Audio("/sound/eated.mp3");
const gameOverSound = new Audio("/sound/gameover.mp3");

document.getElementById("useAI").addEventListener("change", (e)=>useAI=e.target.checked);
document.getElementById("playAgain").addEventListener("click", startGame);

function startGame(){
    clearInterval(interval);
    score = 0;
    scoreEl.textContent = score;
    d = null;
    snake = [{x:9*box, y:9*box}];
    food = randomFood();
    interval = setInterval(draw, 150); // slower speed
}

function randomFood(){
    let fx, fy;
    do {
        fx = Math.floor(Math.random()*19)*box;
        fy = Math.floor(Math.random()*19)*box;
    } while(snake.some(s=>s.x===fx && s.y===fy));
    return {x:fx, y:fy};
}

document.addEventListener("keydown", e=>{
    if(!useAI){
        if(e.key === "ArrowLeft" && d!=="RIGHT") d="LEFT";
        if(e.key === "ArrowRight" && d!=="LEFT") d="RIGHT";
        if(e.key === "ArrowUp" && d!=="DOWN") d="UP";
        if(e.key === "ArrowDown" && d!=="UP") d="DOWN";
    }
});

function collision(head){
    return snake.slice(1).some(s=>s.x===head.x && s.y===head.y);
}

function draw(){
    ctx.fillStyle="#222";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    ctx.fillStyle="#f00";
    ctx.fillRect(food.x, food.y, box, box);

    for(let i=0;i<snake.length;i++){
        ctx.fillStyle=(i===0)?"#00f":"#55f";
        ctx.fillRect(snake[i].x, snake[i].y, box, box);
        ctx.strokeStyle="#000";
        ctx.strokeRect(snake[i].x, snake[i].y, box, box);
    }

    if(useAI) d = getAIMove();

    if(!d) return;

    let newHead = {x: snake[0].x, y: snake[0].y};
    if(d==="LEFT") newHead.x -= box;
    if(d==="RIGHT") newHead.x += box;
    if(d==="UP") newHead.y -= box;
    if(d==="DOWN") newHead.y += box;

    if(newHead.x<0 || newHead.x>=canvas.width || newHead.y<0 || newHead.y>=canvas.height || collision(newHead)){
        clearInterval(interval);
        gameOverSound.play();
        return;
    }

    snake.unshift(newHead);

    if(newHead.x===food.x && newHead.y===food.y){
        score++;
        scoreEl.textContent = score;
        eatSound.play();
        food = randomFood();
    } else {
        snake.pop();
    }
}

// ================= AI =================
function getAIMove(){
    const dirs = ["LEFT","UP","RIGHT","DOWN"];
    const opposite = { "LEFT":"RIGHT","RIGHT":"LEFT","UP":"DOWN","DOWN":"UP" };
    let bestDir=null;
    let bestScore=-Infinity;

    for(let dir of dirs){
        if(d && dir===opposite[d]) continue; // no reversing
        let score = simulate(dir,5); // 5-step lookahead
        if(score>bestScore){ bestScore=score; bestDir=dir; }
    }
    return bestDir;
}

function simulate(dir, steps){
    let simSnake = JSON.parse(JSON.stringify(snake));
    let simFood = {...food};
    let simDir = dir;
    let score = 0;

    for(let i=0;i<steps;i++){
        let head = {x: simSnake[0].x, y: simSnake[0].y};
        if(simDir==="LEFT") head.x -= box;
        if(simDir==="RIGHT") head.x += box;
        if(simDir==="UP") head.y -= box;
        if(simDir==="DOWN") head.y += box;

        // collision with wall or self
        if(head.x<0 || head.x>=canvas.width || head.y<0 || head.y>=canvas.height || simSnake.some(s=>s.x===head.x && s.y===head.y)){
            score -= 1000; // heavy penalty for dying
            break;
        }

        simSnake.unshift(head);
        if(head.x===simFood.x && head.y===simFood.y){
            score += 100;
            simFood = randomFoodForSim(simSnake);
        } else {
            simSnake.pop();
        }

        // favor moving closer to food
        score -= Math.abs(head.x-simFood.x)/box + Math.abs(head.y-simFood.y)/box;
    }

    return score;
}

function randomFoodForSim(simSnake){
    let fx, fy;
    do{
        fx = Math.floor(Math.random()*19)*box;
        fy = Math.floor(Math.random()*19)*box;
    } while(simSnake.some(s=>s.x===fx && s.y===fy));
    return {x:fx, y:fy};
}

startGame();
</script>
</body>
</html>
