<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Blue Snake AI</title>
<style>
    body { display:flex; flex-direction:column; align-items:center; background:#222; font-family:Arial; color:#fff; margin:0; padding:20px;}
    canvas { background:#111; border:3px solid #00f; border-radius:8px; margin:20px 0;}
    h1 { margin:10px 0;}
    label, button, input { margin:10px; font-size:1.2em;}
    button { padding:8px 16px; cursor:pointer; background:#00f; color:#fff; border:none; border-radius:5px;}
    button:hover { background:#0055ff;}
    input { width:60px; }
    #overlay {
        position:absolute; top:0; left:0; width:100%; height:100%;
        background:rgba(0,0,0,0.8); color:white; font-size:48px;
        display:flex; justify-content:center; align-items:center;
        z-index:10; flex-direction:column; display:none;
    }
</style>
</head>
<body>
<h1>Blue Snake</h1>

<label><input type="checkbox" id="useAI"> Use AI</label>
<label><input type="checkbox" id="showPath"> Show AI Path</label>

<br>
<label>Map Size: <input type="number" id="mapSizeInput" value="15" min="5" max="50"></label>
<label>Apples: <input type="number" id="appleCountInput" value="5" min="1" max="20"></label>

<br>
<label>Speed: <input type="range" id="speedSlider" min="50" max="300" value="120"> </label>

<canvas id="snake" width="480" height="480"></canvas>

<h1>Score: <span id="score">0</span></h1>
<button id="playAgain">Play Again</button>

<div id="overlay"><div id="overlayText"></div><button onclick="initGame()">Play Again</button></div>

<script>
const cvs = document.getElementById("snake");
const ctx = cvs.getContext("2d");
const speedSlider = document.getElementById("speedSlider");

let box = 32;
let gridSize, appleCount, snake, foods, score, d, game;

const useAI = document.getElementById("useAI");
const showPath = document.getElementById("showPath");
const overlay = document.getElementById("overlay");
const overlayText = document.getElementById("overlayText");

let dead = new Audio("/sound/gameover.mp3");
let eat = new Audio("/sound/eated.mp3");

// ------------------------------------------------ INITIALIZE GAME
function initGame() {
    gridSize = parseInt(document.getElementById("mapSizeInput").value);
    appleCount = parseInt(document.getElementById("appleCountInput").value);
    cvs.width = cvs.height = gridSize * box;

    snake = [{x: Math.floor(gridSize/2)*box, y: Math.floor(gridSize/2)*box}];
    score = 0;
    d = "RIGHT";
    foods = Array.from({length:appleCount}, spawnFood);

    overlay.style.display="none";
    if(game) clearInterval(game);
    game = setInterval(draw, 400 - speedSlider.value);
}

speedSlider.oninput = () => {
    if(game){ clearInterval(game); game = setInterval(draw, 400 - speedSlider.value); }
};

// ------------------------------------------------ FOOD
function spawnFood() {
    let f;
    do { f={x:Math.floor(Math.random()*gridSize)*box, y:Math.floor(Math.random()*gridSize)*box}; }
    while (snake.some(s=>s.x===f.x && s.y===f.y) || foods?.some(a=>a.x===f.x && a.y===f.y));
    return f;
}

// ------------------------------------------------ COLLISION
function collision(h, arr){ return arr.some(s => s.x===h.x && s.y===h.y); }

// ------------------------------------------------ A* PATHFINDING
function aStar(start, goal, body) {
    const open = [start];
    const came = {};
    const g = {};
    const f = {};
    const key = (x,y)=>x+","+y;
    const neigh = [[box,0],[-box,0],[0,box],[0,-box]];

    g[key(start.x,start.y)] = 0;
    f[key(start.x,start.y)] = Math.abs(start.x-goal.x)+Math.abs(start.y-goal.y);

    while(open.length){
        open.sort((a,b)=>f[key(a.x,a.y)]-f[key(b.x,b.y)]);
        let cur=open.shift();
        if(cur.x===goal.x && cur.y===goal.y){
            let path=[];
            let k=key(cur.x,cur.y);
            while(k in came){ path.unshift(came[k].d); let p=came[k].p; k=key(p.x,p.y); }
            return path;
        }
        for(let [dx,dy] of neigh){
            let nx=cur.x+dx, ny=cur.y+dy;
            if(nx<0||ny<0||nx>=gridSize*box||ny>=gridSize*box) continue;
            if(body.some(s=>s.x===nx&&s.y===ny)&&!(nx===goal.x&&ny===goal.y)) continue;
            let nk=key(nx,ny);
            let g2=g[key(cur.x,cur.y)]+1;
            if(!(nk in g)||g2<g[nk]){
                g[nk]=g2;
                f[nk]=g2+Math.abs(nx-goal.x)+Math.abs(ny-goal.y);
                came[nk]={p:cur,d:dx===box?"RIGHT":dx===-box?"LEFT":dy===box?"DOWN":"UP"};
                if(!open.some(o=>o.x===nx&&o.y===ny)) open.push({x:nx,y:ny});
            }
        }
    }
    return [];
}

// ------------------------------------------------ FLOOD FILL (SPACE CHECK)
function floodFill(x,y,body){
    let v={},q=[{x,y}],c=0,k=p=>p.x+","+p.y;
    while(q.length){
        let p=q.shift();
        if(p.x<0||p.y<0||p.x>=gridSize*box||p.y>=gridSize*box)continue;
        if(v[k(p)])continue;
        if(body.some(s=>s.x===p.x&&s.y===p.y))continue;
        v[k(p)]=1; c++;
        q.push({x:p.x+box,y:p.y});q.push({x:p.x-box,y:p.y});q.push({x:p.x,y:p.y+box});q.push({x:p.x,y:p.y-box});
    }
    return c;
}

// ------------------------------------------------ AI MOVE
function getAIMove(){
    if(!useAI.checked) return d;

    let best=null, bestScore=-Infinity;
    for(let f of foods){
        let path=aStar(snake[0],f,snake);
        if(!path.length) continue;

        let sim=snake.map(s=>({...s}));
        let h={...sim[0]};
        for(let m of path){
            if(m==="UP")h.y-=box; if(m==="DOWN")h.y+=box; if(m==="LEFT")h.x-=box; if(m==="RIGHT")h.x+=box;
            sim.unshift({...h}); sim.pop();
        }
        let free=floodFill(h.x,h.y,sim);
        if(free>bestScore){ bestScore=free; best=f; }
    }
    if(!best) return d;
    let bestPath=aStar(snake[0],best,snake);
    if(showPath.checked){
        let pos={...snake[0]};
        ctx.fillStyle="rgba(0,200,255,0.5)";
        for(let m of bestPath){
            if(m==="UP")pos.y-=box; if(m==="DOWN")pos.y+=box; if(m==="LEFT")pos.x-=box; if(m==="RIGHT")pos.x+=box;
            ctx.fillRect(pos.x+8,pos.y+8,box-16,box-16);
        }
    }
    return bestPath[0]||d;
}

// ------------------------------------------------ MANUAL INPUT
document.addEventListener("keydown", e=>{
    if(useAI.checked) return;
    if(e.key==="ArrowUp"&&d!=="DOWN")d="UP";
    if(e.key==="ArrowDown"&&d!=="UP")d="DOWN";
    if(e.key==="ArrowLeft"&&d!=="RIGHT")d="LEFT";
    if(e.key==="ArrowRight"&&d!=="LEFT")d="RIGHT";
});

// ------------------------------------------------ DRAW
function draw(){
    ctx.fillStyle="#111";
    ctx.fillRect(0,0,cvs.width,cvs.height);

    snake.forEach((s,i)=>{ctx.fillStyle=i? "lightblue":"blue";ctx.fillRect(s.x,s.y,box,box);ctx.strokeStyle="darkblue";ctx.strokeRect(s.x,s.y,box,box);});
    foods.forEach(f=>{ctx.fillStyle="red";ctx.fillRect(f.x,f.y,box,box);});

    d=getAIMove();

    let x=snake[0].x, y=snake[0].y;
    if(d==="UP")y-=box; if(d==="DOWN")y+=box; if(d==="LEFT")x-=box; if(d==="RIGHT")x+=box;
    let head={x,y};

    for(let i=0;i<foods.length;i++){
        if(x===foods[i].x && y===foods[i].y){ score++; eat.play(); foods[i]=spawnFood(); snake.push({...snake.at(-1)}); }
    }

    if(x<0||y<0||x>=gridSize*box||y>=gridSize*box||collision(head,snake)){
        clearInterval(game); dead.play(); overlayText.textContent="You Died!"; overlay.style.display="flex"; return;
    }

    snake.unshift(head); snake.pop();
    document.getElementById("score").textContent=score;

    if(snake.length>=gridSize*gridSize){
        clearInterval(game); overlayText.textContent="You Won!"; overlay.style.display="flex";
    }
}

document.getElementById("playAgain").onclick=initGame;

initGame();
</script>
</body>
</html>
